<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minecraft Mod Compatibility Checker</title>
    <style>
        :root {
            --primary: #32b8c6;
            --primary-dark: #1a7481;
            --bg-dark: #1f2121;
            --bg-light: #2a2d2d;
            --text-primary: #f5f5f5;
            --text-secondary: #a7a9a9;
            --success: #32c659;
            --warning: #e68179;
            --error: #c01547;
            --border: rgba(119, 124, 124, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 30px 0;
            margin-bottom: 30px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        h1 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .subtitle {
            font-size: 14px;
            opacity: 0.9;
        }

        .status-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .status-card {
            background: var(--bg-light);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .status-icon {
            font-size: 24px;
            min-width: 30px;
        }

        .status-content h3 {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-content p {
            font-size: 16px;
            font-weight: 500;
        }

        .status-card.loading .status-icon {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .main-content {
            display: block;
            margin-bottom: 30px;
        }

        .panel {
            background: var(--bg-light);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
        }

        .panel-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 6px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 14px;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(50, 184, 198, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 200ms ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--bg-dark);
            width: 100%;
            justify-content: center;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(50, 184, 198, 0.2);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: transparent;
            color: var(--primary);
            border: 1px solid var(--primary);
            padding: 8px 12px;
            font-size: 12px;
        }

        .btn-secondary:hover {
            background: rgba(50, 184, 198, 0.1);
        }

        .btn-sm {
            padding: 6px 10px;
            font-size: 12px;
        }

        .mods-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .mod-item,
        .version-item {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: start;
            transition: all 200ms ease;
        }

        .mod-item:hover,
        .version-item:hover {
            border-color: var(--primary);
            background: rgba(50, 184, 198, 0.05);
        }

        .mod-info,
        .version-info-text {
            flex: 1;
        }

        .mod-name {
            font-weight: 500;
            margin-bottom: 4px;
        }

        .mod-side {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .mod-slug {
            font-size: 12px;
            color: var(--primary);
            font-family: 'Courier New', monospace;
        }

        .mod-actions,
        .version-actions {
            display: flex;
            gap: 8px;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-client {
            background: rgba(100, 150, 200, 0.2);
            color: #64a8c8;
        }

        .badge-server {
            background: rgba(80, 150, 120, 0.2);
            color: #50b878;
        }

        .badge-fabric {
            background: rgba(100, 120, 180, 0.2);
            color: #6478b4;
        }

        .badge-forge {
            background: rgba(180, 120, 80, 0.2);
            color: #b47850;
        }

        .badge-quilt {
            background: rgba(150, 100, 180, 0.2);
            color: #9664b4;
        }

        .badge-neoforge {
            background: rgba(180, 150, 80, 0.2);
            color: #b49650;
        }

        .badge-success {
            background: rgba(50, 198, 89, 0.2);
            color: var(--success);
        }

        .badge-warning {
            background: rgba(230, 129, 97, 0.2);
            color: #e68179;
        }

        .badge-error {
            background: rgba(192, 21, 47, 0.2);
            color: var(--error);
        }

        .badge-current {
            background: rgba(50, 198, 89, 0.2);
            color: var(--success);
        }

        .compatibility-result {
            background: var(--bg-dark);
            border-left: 3px solid var(--border);
            border-radius: 4px;
            padding: 12px;
            margin-bottom: 10px;
            font-size: 13px;
        }

        .compatibility-result.compatible {
            border-left-color: var(--success);
            background: rgba(50, 198, 89, 0.05);
        }

        .compatibility-result.incompatible {
            border-left-color: var(--error);
            background: rgba(192, 21, 47, 0.05);
        }

        .compatibility-result.error {
            border-left-color: var(--warning);
            background: rgba(230, 129, 97, 0.05);
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .result-name {
            font-weight: 500;
        }

        .result-status {
            font-size: 12px;
            font-weight: 600;
        }

        .result-details {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 6px;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .separator {
            height: 1px;
            background: var(--border);
            margin: 20px 0;
        }

        .last-check {
            font-size: 12px;
            color: var(--text-secondary);
            text-align: center;
            margin-top: 15px;
        }

        .version-info-box {
            background: rgba(50, 184, 198, 0.1);
            border: 1px solid var(--primary);
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 15px;
            font-size: 13px;
        }

        .version-info-label {
            color: var(--text-secondary);
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .version-info-value {
            font-weight: 500;
            color: var(--primary);
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 22px;
            }

            .status-bar {
                grid-template-columns: 1fr 1fr;
            }
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border);
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 10px 15px;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid transparent;
            transition: all 200ms ease;
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--bg-light);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            animation: slideIn 300ms ease;
            z-index: 1000;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast.success {
            border-left: 3px solid var(--success);
        }

        .toast.error {
            border-left: 3px solid var(--error);
        }

        .toast.info {
            border-left: 3px solid var(--primary);
        }

        .language-selector {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 100;
        }

        .language-selector select {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
            border-radius: 4px;
            width: auto;
        }

        .language-selector select option {
            background: var(--bg-dark);
            color: var(--text-primary);
        }

        @media (max-width: 768px) {
            .language-selector {
                top: 10px;
                right: 10px;
            }
        }
    </style>
    <script src="/static/locales/en.js"></script>
    <script src="/static/locales/pl.js"></script>
    <script src="/static/i18n.js"></script>
</head>


<body>
    <header>
        <div class="container" style="position: relative;">
            <div class="language-selector">
                <select id="languageSelector" onchange="i18n.setLanguage(this.value)">
                    <option value="en">English (EN)</option>
                    <option value="pl">Polski (PL)</option>
                </select>
            </div>
            <h1 data-i18n="title">üéÆ Minecraft Mod Compatibility Checker</h1>
            <p class="subtitle" data-i18n="subtitle">Check your mod compatibility with your Minecraft server version</p>
        </div>
    </header>


    <div class="container">
        <div class="status-bar">
            <div class="status-card" id="currentVersionCard" style="cursor: pointer; transition: transform 0.2s;"
                onclick="onBadgeClick(currentVersion)">
                <div class="status-icon">üì¶</div>
                <div class="status-content" style="flex: 1;">
                    <h3 data-i18n="current_mc_version">Current MC Version</h3>
                    <p id="currentVersion" data-i18n="not_set">Not Set</p>

                    <div id="currentVersionSummary"
                        style="margin-top: 8px; display: flex; flex-direction: column; gap: 4px;"></div>
                </div>
            </div>
            <div class="status-card" id="latestOfficialCard" style="cursor: pointer; transition: transform 0.2s;"
                onclick="onBadgeClick(latestOfficialVersion)">
                <div class="status-icon">üöÄ</div>
                <div class="status-content" style="flex: 1;">
                    <h3 data-i18n="latest_official">Latest Official</h3>
                    <p id="latestOfficialVersion" data-i18n="checking">Checking...</p>

                    <div id="latestOfficialSummary"
                        style="margin-top: 8px; display: flex; flex-direction: column; gap: 4px;"></div>
                </div>
            </div>
            <div class="status-card">
                <div class="status-icon">‚è±Ô∏è</div>
                <div class="status-content">
                    <h3 data-i18n="background_check_status">Background Check Status</h3>
                    <p id="lastCheckTime" style="font-size: 14px;"></p>

                    <p id="nextCheckTime" style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">Next:
                        --:--:--</p>
                </div>
            </div>
            <div class="status-card">
                <div class="status-icon">üìö</div>
                <div class="status-content">
                    <h3 data-i18n="tracked_mods">Tracked Mods</h3>
                    <p id="modsCount">0</p>
                </div>
            </div>
            <div class="status-card">
                <div class="status-icon">‚úì</div>
                <div class="status-content">
                    <h3 data-i18n="compatible_mods">Compatible Mods</h3>
                    <p id="compatCount">0 / 0</p>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="panel">
                <div class="tabs">
                    <button class="tab-btn active" onclick=" switchTab('results')"
                        data-i18n="tabs.results">Compatibility Results</button>
                    <button class="tab-btn" onclick="switchTab('add-mod')" data-i18n="tabs.add_mod">Add Mod</button>
                    <button class="tab-btn" onclick="switchTab('versions')" data-i18n="tabs.versions">Manage
                        Versions</button>
                    <button class="tab-btn" onclick="switchTab('import-export')"
                        data-i18n="tabs.import_export">Export/Import</button>
                    <button class="tab-btn" onclick="switchTab('logs')" data-i18n="tabs.logs">Background Job
                        Logs</button>
                </div>


                <div id="add-mod" class="tab-content">
                    <div class="panel-title" data-i18n="add_mod_panel.title">üìù Add Mod to Track</div>

                    <div class="form-group">
                        <label data-i18n="add_mod_panel.slug_label">Mod Slug (from Modrinth)</label>
                        <input type="text" id="modSlug" data-i18n="add_mod_panel.slug_placeholder"
                            data-i18n-attr="placeholder" placeholder="e.g., sodium, lithium, iris">
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label data-i18n="add_mod_panel.type_label">Preferred Type</label>
                            <select id="modSide">
                                <option value="both" data-i18n="add_mod_panel.type_both">Both (Client + Server)</option>
                                <option value="client" data-i18n="add_mod_panel.type_client">Client Only</option>
                                <option value="server" data-i18n="add_mod_panel.type_server">Server Only</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label data-i18n="add_mod_panel.channel_label">Stability Channel</label>
                            <select id="modChannel">
                                <option value="release" data-i18n="add_mod_panel.channel_stable">Stable Releases Only
                                </option>
                                <option value="beta" data-i18n="add_mod_panel.channel_beta">Include Beta Versions
                                </option>
                                <option value="alpha" data-i18n="add_mod_panel.channel_alpha">Include Alpha Versions
                                </option>
                            </select>
                        </div>
                    </div>

                    <button class="btn btn-primary" onclick="addMod()" data-i18n="add_mod_panel.add_btn">‚ûï Add
                        Mod</button>

                    <div class="separator"></div>
                    <div class="panel-title" data-i18n="add_mod_panel.list_title">üìã Tracked Mods</div>

                    <div class="mods-list" id="modsList">
                        <div class="empty-state">
                            <div class="empty-state-icon">üì≠</div>
                            <p data-i18n="add_mod_panel.empty">No mods tracked yet</p>
                        </div>
                    </div>
                </div>


                <div id="versions" class="tab-content">
                    <div class="panel-title" data-i18n="manage_versions_panel.title">üîß Manage Minecraft Versions</div>

                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 10px;">
                        <div class="form-group">
                            <label data-i18n="manage_versions_panel.version_label">Version (e.g., 1.21.1)</label>
                            <input type="text" id="newVersion" data-i18n="manage_versions_panel.version_placeholder"
                                data-i18n-attr="placeholder" placeholder="1.21.1">
                        </div>
                        <div class="form-group">
                            <label data-i18n="manage_versions_panel.loader_label">Loader</label>
                            <select id="versionLoader">
                                <option value="fabric">Fabric</option>
                                <option value="forge">Forge</option>
                                <option value="quilt">Quilt</option>
                                <option value="neoforge">NeoForge</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label data-i18n="manage_versions_panel.type_label">Type</label>
                            <select id="versionType">
                                <option value="release" data-i18n="manage_versions_panel.type_release">Release</option>
                                <option value="snapshot" data-i18n="manage_versions_panel.type_snapshot">Snapshot
                                </option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 15px;">
                            <input type="checkbox" id="setAsCurrent" style="width: auto; margin-right: 8px;">
                            <span data-i18n="manage_versions_panel.set_current_label">Set as current server
                                version</span>
                        </label>
                    </div>

                    <button class="btn btn-primary" onclick="addVersion()" data-i18n="manage_versions_panel.add_btn">‚ûï
                        Add Version</button>

                    <div class="separator"></div>
                    <div class="panel-title" data-i18n="manage_versions_panel.list_title">üìå Version List</div>

                    <div class="mods-list" id="versionsList">
                        <div class="empty-state">
                            <div class="empty-state-icon">üì≠</div>
                            <p data-i18n="manage_versions_panel.empty">No versions added yet</p>
                        </div>
                    </div>
                </div>


                <div id="import-export" class="tab-content">
                    <div class="panel-title" data-i18n="import_export_panel.title">üì§ Export / üì• Import</div>
                    <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 12px;"
                        data-i18n="import_export_panel.description">
                        Manage your mod list using Docker Compose format (<code>itzg/minecraft-server</code> style).
                    </p>

                    <div class="form-group">
                        <label data-i18n="import_export_panel.export_version_label">Select Minecraft Version for
                            Export</label>
                        <select id="exportVersionSelect">
                            <option value="" data-i18n="import_export_panel.no_compatible_versions">No compatible
                                versions found</option>
                        </select>
                        <p style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;"
                            data-i18n="import_export_panel.export_hint">Only versions where
                            all
                            server/both mods are compatible are shown (client-only mods are ignored).</p>
                    </div>

                    <div class="form-group">
                        <label data-i18n="import_export_panel.yaml_label">Compose YAML / MODRINTH_PROJECTS</label>
                        <textarea id="yamlContent" data-i18n="import_export_panel.yaml_placeholder"
                            data-i18n-attr="placeholder" placeholder="Paste your docker-compose.yml here..."></textarea>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <button class="btn btn-secondary" onclick="exportMods()"
                            data-i18n="import_export_panel.export_btn">üì§ Export Current</button>
                        <button class="btn btn-primary" onclick="importMods()"
                            data-i18n="import_export_panel.import_btn">üì• Import from Above</button>
                    </div>
                </div>


                <div id="results" class="tab-content active">
                    <div class="version-info-box"
                        style="display: flex; justify-content: space-between; align-items: flex-end; gap: 15px;">
                        <div style="flex: 1;">
                            <div class="version-info-label" data-i18n="results_panel.filter_version_label">Filter by
                                Minecraft Version</div>
                            <select id="resultVersionFilter" onchange="fetchResults()"
                                style="background: var(--bg-dark); border: 1px solid var(--border); border-radius: 4px; padding: 6px 10px; color: var(--text-primary); font-size: 13px; width: 100%;">
                                <option value="" data-i18n="results_panel.all_versions">All Versions</option>
                            </select>
                        </div>
                        <div style="flex: 1;">
                            <div class="version-info-label" data-i18n="results_panel.filter_type_label">Filter by Mod
                                Type</div>
                            <select id="resultSideFilter" onchange="fetchResults()"
                                style="background: var(--bg-dark); border: 1px solid var(--border); border-radius: 4px; padding: 6px 10px; color: var(--text-primary); font-size: 13px; width: 100%;">
                                <option value="" data-i18n="results_panel.all_types">All Types</option>
                                <option value="server" data-i18n="results_panel.type_server">Server Side (Server + Both)
                                </option>
                                <option value="client" data-i18n="results_panel.type_client">Client Side (Client + Both)
                                </option>
                                <option value="both" data-i18n="results_panel.type_both">Both Only</option>
                            </select>
                        </div>
                    </div>

                    <div id="resultsContainer">
                        <div class="empty-state">
                            <div class="empty-state-icon">üîç</div>
                            <p data-i18n="results_panel.empty">Add mods to see compatibility results</p>
                        </div>
                    </div>
                </div>

                <div id="logs" class="tab-content">
                    <div style="background: var(--bg-dark); border-radius: 6px; padding: 12px; font-family: 'Courier New', monospace; font-size: 12px; max-height: 400px; overflow-y: auto;"
                        id="logsContainer">
                        <div style="color: var(--text-secondary);" data-i18n="logs_panel.waiting">Waiting for background
                            job logs...</div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let mods = [];
        let versions = [];
        let results = [];
        let logs = [];
        let currentVersion = null;
        let currentLoader = null;
        let latestOfficialVersion = null;
        let latestOfficialLoader = null;

        async function loadInitialData() {
            try {
                // Load versions & Determine Latest
                const versionsRes = await fetch(`${API_BASE}/versions`);
                versions = await versionsRes.json();

                // Sort versions desc by release time
                versions.sort((a, b) => {
                    const tA = new Date(a.release_time || 0);
                    const tB = new Date(b.release_time || 0);
                    return tB - tA;
                });

                const latestOfficial = versions.find(v => v.type === 'release');
                if (latestOfficial) {
                    latestOfficialVersion = latestOfficial.version;
                    latestOfficialLoader = latestOfficial.loader;
                    document.getElementById('latestOfficialVersion').innerHTML = `${latestOfficialVersion} (${latestOfficialLoader})`;
                }

                // Populate filter dropdown
                const filterSelect = document.getElementById('resultVersionFilter');
                const currentFilter = filterSelect.value;
                filterSelect.innerHTML = '<option value="">All Versions</option>' +
                    versions.map(v => `<option value="${v.version}|${v.loader}">${v.version} (${v.loader})${v.is_current ? ' [Current]' : ''}</option>`).join('');
                filterSelect.value = currentFilter;

                // Load current version
                const currentRes = await fetch(`${API_BASE}/versions/current`);
                const currentData = await currentRes.json();

                if (currentData && currentData.version) {
                    currentVersion = currentData.version;
                    currentLoader = currentData.loader;
                    document.getElementById('currentVersion').innerHTML = `${currentVersion} (${currentLoader})`;
                    document.getElementById('currentVersion').removeAttribute('data-i18n');
                } else {
                    currentVersion = null;
                    currentLoader = null;
                    document.getElementById('currentVersion').setAttribute('data-i18n', 'not_set');
                    i18n.updateUI();
                }


                renderVersions();

                // Load mods
                const modsRes = await fetch(`${API_BASE}/mods`);
                mods = await modsRes.json();
                renderMods();

                // Load results
                await fetchResults();
                await populateExportVersions();

                // Load logs
                const logsRes = await fetch(`${API_BASE}/logs`);
                logs = await logsRes.json();
                renderLogs();

                updateStats();
                await loadBackgroundStatus();
            } catch (error) {
                showToast(i18n.t('toasts.failed_load'), 'error');
                console.error(error);
            }

        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            return new Date(dateStr).toLocaleDateString();
        }

        async function addVersion() {
            const versionStr = document.getElementById('newVersion').value.trim();
            const loader = document.getElementById('versionLoader').value;
            const type = document.getElementById('versionType').value;
            const isCurrent = document.getElementById('setAsCurrent').checked;

            if (!versionStr) {
                showToast(i18n.t('toasts.enter_version'), 'error');
                return;
            }


            try {
                const res = await fetch(`${API_BASE}/versions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ version: versionStr, loader, type, is_current: isCurrent })
                });

                if (!res.ok) {
                    const error = await res.json();
                    throw new Error(error.detail || 'Failed to add version');
                }

                showToast(i18n.t('toasts.version_added'), 'success');
                loadInitialData();

                document.getElementById('newVersion').value = '';
                document.getElementById('setAsCurrent').checked = false;

            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        async function setCurrentVersion(id) {
            try {
                const res = await fetch(`${API_BASE}/versions/${id}/set-current`, {
                    method: 'PUT'
                });

                if (!res.ok) {
                    const error = await res.json();
                    throw new Error(error.detail || 'Failed to set current version');
                }

                showToast(i18n.t('toasts.current_updated'), 'success');
                loadInitialData();

            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        async function deleteVersion(id) {
            if (!confirm(i18n.t('version_item.delete_confirm'))) {
                return;
            }


            try {
                const res = await fetch(`${API_BASE}/versions/${id}`, {
                    method: 'DELETE'
                });

                if (!res.ok) {
                    const error = await res.json();
                    throw new Error(error.detail || 'Failed to delete version');
                }

                showToast(i18n.t('toasts.version_deleted'), 'success');
                loadInitialData();

            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        function renderVersions() {
            const container = document.getElementById('versionsList');
            if (versions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì≠</div>
                        <p data-i18n="manage_versions_panel.empty">${i18n.t('manage_versions_panel.empty')}</p>
                    </div>
                `;
                return;
            }


            container.innerHTML = versions.map(v => `
                <div class="version-item">
                    <div class="version-info-text">
                        <div class="mod-name">${v.version}</div>
                        <div class="mod-side">
                           ${v.loader.toUpperCase()} ‚Ä¢ ${v.type ? i18n.t(`manage_versions_panel.type_${v.type}`) : i18n.t('manage_versions_panel.type_release')} ‚Ä¢ ${formatDate(v.release_time) || i18n.t('version_item.unknown_date')}
                        </div>
                        ${v.is_current ? `<span class="badge badge-current">üéØ ${i18n.t('badges.current')}</span>` : ''}
                    </div>
    
                    <div class="version-actions">
                        ${!v.is_current ? `<button class="btn btn-secondary btn-sm" onclick="setCurrentVersion(${v.id})">${i18n.t('version_item.set_current_btn')}</button>` : ''}
                        <button class="btn btn-secondary btn-sm" onclick="deleteVersion(${v.id})">${i18n.t('version_item.delete_btn')}</button>
                    </div>

                </div>
            `).join('');
        }

        async function fetchResults() {
            try {
                const mcFilterVal = document.getElementById('resultVersionFilter').value;
                const sideFilter = document.getElementById('resultSideFilter').value;
                const url = new URL(`${window.location.origin}${API_BASE}/results`);

                if (mcFilterVal) {
                    const [version, loader] = mcFilterVal.split('|');
                    url.searchParams.append('mc_version', version);
                    url.searchParams.append('loader', loader);
                }
                if (sideFilter) url.searchParams.append('side', sideFilter);

                const res = await fetch(url.toString());
                results = await res.json();
                renderResults();
            } catch (error) {
                console.error('Failed to fetch results', error);
            }
        }

        function renderResults() {
            const container = document.getElementById('resultsContainer');
            if (results.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üîç</div>
                        <p data-i18n="results_panel.empty_filter">${i18n.t('results_panel.empty_filter')}</p>
                    </div>`;

                return;
            }

            // Since backend returns sorted results (Mod name ASC, MC Newest DESC)
            const resultsByMod = {};
            const modOrder = [];

            results.forEach(r => {
                if (!resultsByMod[r.mod_slug]) {
                    resultsByMod[r.mod_slug] = [];
                    modOrder.push(r.mod_slug);
                }
                resultsByMod[r.mod_slug].push(r);
            });

            let html = '';

            for (const modSlug of modOrder) {
                const modResults = resultsByMod[modSlug];

                // Get most recent check for each MC version to avoid duplicates in display
                const uniqueChecks = {};
                modResults.forEach(r => {
                    if (!uniqueChecks[r.mc_version]) uniqueChecks[r.mc_version] = r;
                });

                const versionsShown = [];
                modResults.forEach(r => {
                    if (!versionsShown.includes(r.mc_version)) versionsShown.push(r.mc_version);
                });

                html += `
                    <div class="compatibility-result">
                        <div class="result-header">
                            <span class="result-name">${modSlug}</span>
                        </div>
                        <div class="separator" style="margin: 8px 0;"></div>
                 `;

                versionsShown.forEach(ver => {
                    const r = uniqueChecks[ver];
                    let badgeClass = 'badge-warning';
                    if (r.status === 'compatible') badgeClass = 'badge-success';
                    if (r.status === 'incompatible') badgeClass = 'badge-error';

                    let statusText = r.status === 'compatible' ? `‚úì ${i18n.t('status.compatible', { defaultValue: 'Compatible' })}` :
                        r.status === 'incompatible' ? `‚úó ${i18n.t('status.incompatible', { defaultValue: 'Incompatible' })}` : `‚ö†Ô∏è ${i18n.t('status.error', { defaultValue: 'Error' })}`;

                    // Temporary fix for status translation if not in primary object
                    if (r.status === 'compatible') statusText = '‚úì ' + (i18n.currentLang === 'pl' ? 'Kompatybilny' : 'Compatible');
                    if (r.status === 'incompatible') statusText = '‚úó ' + (i18n.currentLang === 'pl' ? 'Niekompatybilny' : 'Incompatible');
                    if (r.status === 'error') statusText = '‚ö†Ô∏è ' + (i18n.currentLang === 'pl' ? 'B≈ÇƒÖd' : 'Error');


                    // Display both version number and ID if available
                    let versionDisplay = '';
                    if (r.mod_version_number && r.mod_version_id) {
                        versionDisplay = `${r.mod_version_number} (${r.mod_version_id})`;
                    } else {
                        versionDisplay = r.mod_version_number || r.mod_version_id || i18n.t('results_item.unknown');
                    }

                    html += `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                            <div style="font-size: 13px;">
                                <span style="font-weight: 600;">MC ${ver}</span>
                                <span style="color: var(--text-secondary); font-size: 11px; margin-left: 8px;">(${r.loader})</span>
                            </div>
                            <span class="badge ${badgeClass}">${statusText}</span>
                        </div>
                        ${versionDisplay !== i18n.t('results_item.unknown') ? `<div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;"><strong>${i18n.t('results_item.mod_version')}</strong> ${versionDisplay}</div>` : ''}
                        ${r.error ? `<div class="result-details" style="color:var(--error)">${r.error}</div>` : ''}

                     `;
                });
                html += `</div>`;
            }

            container.innerHTML = html;
        }

        async function addMod() {
            const slug = document.getElementById('modSlug').value.trim();
            const side = document.getElementById('modSide').value;
            const channel = document.getElementById('modChannel').value;

            if (!slug) {
                showToast(i18n.t('toasts.enter_slug'), 'error');
                return;
            }


            try {
                const res = await fetch(`${API_BASE}/mods`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ slug, side, channel })
                });

                if (!res.ok) {
                    const error = await res.json();
                    throw new Error(error.detail || 'Failed to add mod');
                }

                const newMod = await res.json();
                mods.push(newMod);
                renderMods();
                updateStats();
                document.getElementById('modSlug').value = '';
                showToast(i18n.t('toasts.mod_added'), 'success');

            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        async function updateModSide(slug, side) {
            try {
                const res = await fetch(`${API_BASE}/mods/${slug}/side`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ side })
                });

                if (!res.ok) {
                    const error = await res.json();
                    throw new Error(error.detail || 'Failed to update side');
                }

                showToast(i18n.t('toasts.side_updated'), 'success');

                // Update local state
                const mod = mods.find(m => m.slug === slug);
                if (mod) mod.side = side;

                // Trigger results refresh since side changed
                fetchResults();
                updateStats();
            } catch (error) {
                showToast(error.message, 'error');
                // Re-render to revert change if needed
                renderMods();
            }
        }

        async function updateModChannel(slug, channel) {
            try {
                const res = await fetch(`${API_BASE}/mods/${slug}/channel`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ channel })
                });

                if (!res.ok) {
                    const error = await res.json();
                    throw new Error(error.detail || 'Failed to update channel');
                }

                showToast(i18n.t('toasts.channel_updated'), 'success');

                const mod = mods.find(m => m.slug === slug);
                if (mod) mod.channel = channel;

                fetchResults();
                updateStats();
            } catch (error) {
                showToast(error.message, 'error');
                renderMods();
            }
        }

        async function removeMod(slug) {
            try {
                const res = await fetch(`${API_BASE}/mods/${slug}`, { method: 'DELETE' });
                if (res.ok) {
                    mods = mods.filter(m => m.slug !== slug);
                    renderMods();
                    updateStats();
                    showToast(i18n.t('toasts.mod_removed'), 'success');
                }
            } catch (error) {
                showToast(i18n.t('toasts.failed_remove'), 'error');
            }

        }

        function renderMods() {
            const container = document.getElementById('modsList');
            if (mods.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì≠</div>
                        <p data-i18n="add_mod_panel.empty">${i18n.t('add_mod_panel.empty')}</p>
                    </div>
                `;
                return;
            }


            container.innerHTML = mods.map(mod => {
                const canBeClient = mod.supported_client_side !== 'unsupported';
                const canBeServer = mod.supported_server_side !== 'unsupported';

                return `
                <div class="mod-item">
                    <div class="mod-info">
                        <div class="mod-name">${mod.slug}</div>
                        <div class="mod-side" style="margin-top: 5px;">
                            <select onchange="updateModSide('${mod.slug}', this.value)" style="width: auto; padding: 2px 5px; font-size: 11px; height: 24px; background: var(--bg-light); margin-right: 5px;">
                                <option value="both" ${mod.side === 'both' ? 'selected' : ''} ${(!canBeClient || !canBeServer) ? 'disabled' : ''}>üñ•Ô∏è Both</option>
                                <option value="client" ${mod.side === 'client' ? 'selected' : ''} ${!canBeClient ? 'disabled' : ''}>üë§ Client Only</option>
                                <option value="server" ${mod.side === 'server' ? 'selected' : ''} ${!canBeServer ? 'disabled' : ''}>üñß Server Only</option>
                            </select>
                            <select onchange="updateModChannel('${mod.slug}', this.value)" style="width: auto; padding: 2px 5px; font-size: 11px; height: 24px; background: var(--bg-light);">
                                <option value="release" ${mod.channel === 'release' ? 'selected' : ''}>üì¶ ${i18n.t('add_mod_panel.channel_stable')}</option>
                                <option value="beta" ${mod.channel === 'beta' ? 'selected' : ''}>üß™ ${i18n.t('add_mod_panel.channel_beta')}</option>
                                <option value="alpha" ${mod.channel === 'alpha' ? 'selected' : ''}>‚ö†Ô∏è ${i18n.t('add_mod_panel.channel_alpha')}</option>
                            </select>
                        </div>
                        <div style="font-size: 10px; color: var(--text-secondary); margin-top: 6px;">
                            ${i18n.t('mod_item.supports', {
                    client: canBeClient ? i18n.t('badges.client') : `<span style="color:var(--error)">${i18n.t('mod_item.no_client')}</span>`,
                    server: canBeServer ? i18n.t('badges.server') : `<span style="color:var(--error)">${i18n.t('mod_item.no_server')}</span>`
                })}
                        </div>
                    </div>
                    <div class="mod-actions">
                        <button class="btn btn-secondary btn-sm" onclick="removeMod('${mod.slug}')">${i18n.t('mod_item.remove_btn')}</button>
                    </div>

                </div>
            `}).join('');
        }


        function renderLogs() {
            const container = document.getElementById('logsContainer');
            if (logs.length === 0) {
                container.innerHTML = `<div style="color: var(--text-secondary);" data-i18n="logs_panel.no_logs">${i18n.t('logs_panel.no_logs')}</div>`;
                return;
            }

            container.innerHTML = logs.map(log => {
                const timestamp = new Date(log.created_at).toLocaleTimeString();
                const levelColor = log.level === 'ERROR' ? 'var(--error)' :
                    log.level === 'WARNING' ? 'var(--warning)' : 'var(--primary)';
                const translatedMessage = i18n.translateLog(log.message);
                return `<div style="color: ${levelColor}; margin-bottom: 4px;"><strong>[${timestamp}]</strong> ${translatedMessage}</div>`;
            }).join('');


            container.scrollTop = container.scrollHeight;
        }

        async function updateStats() {
            document.getElementById('modsCount').innerHTML = mods.length;

            const compatible = results.filter(r => r.status === 'compatible').length;
            const total = new Set(results.map(r => `${r.mod_slug}-${r.mc_version}-${r.loader}`)).size;
            document.getElementById('compatCount').innerHTML = `${compatible} / ${total}`;


            // Fetch summaries for badges
            const updateBadge = (version, loader, elementId) => {
                const el = document.getElementById(elementId);
                if (!version) {
                    el.innerHTML = '';
                    return;
                }

                fetch(`${API_BASE}/results/summary?mc_version=${version}&loader=${loader}`)
                    .then(res => res.json())
                    .then(data => {
                        const createBadgeSummary = (label, compatible, total, emoji, side) => {
                            let badgeClass = 'badge-warning';
                            let statusEmoji = '‚è≥';

                            if (total > 0) {
                                if (compatible === total) {
                                    badgeClass = 'badge-success';
                                    statusEmoji = '‚úÖ';
                                } else {
                                    badgeClass = 'badge-error';
                                    statusEmoji = '‚ùå';
                                }
                            }

                            return `
                                <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding: 2px 4px; border-radius: 4px; transition: background 0.2s;" 
                                     onmouseover="this.style.background='rgba(255,255,255,0.05)'" 
                                     onmouseout="this.style.background='transparent'"
                                     onclick="event.stopPropagation(); onBadgeClick('${version}|${loader}', '${side}')">
                                    <span style="font-size: 11px; color: var(--text-secondary);">${emoji} ${label}</span>
                                    <span class="badge ${badgeClass}">${compatible} / ${total} ${statusEmoji}</span>
                                </div>
                            `;
                        };

                        el.innerHTML = `
                            ${createBadgeSummary(i18n.t('badges.server'), data.server_compatible, data.server_total, 'üñß', 'server')}
                            ${createBadgeSummary(i18n.t('badges.client'), data.client_compatible, data.client_total, 'üë§', 'client')}
                        `;

                    })
                    .catch(e => console.error('Failed to update badge stats', e));
            };

            if (currentVersion) await updateBadge(currentVersion, currentLoader, 'currentVersionSummary');
            if (latestOfficialVersion) await updateBadge(latestOfficialVersion, latestOfficialLoader, 'latestOfficialSummary');
        }

        function onBadgeClick(versionAndLoader, side = '') {
            if (!versionAndLoader || versionAndLoader === i18n.t('checking') || versionAndLoader === i18n.t('not_set')) return;


            document.getElementById('resultVersionFilter').value = versionAndLoader;
            document.getElementById('resultSideFilter').value = side;

            switchTab('results');
            fetchResults();
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tabs .tab-btn').forEach(el => el.classList.remove('active'));

            document.getElementById(tabId).classList.add('active');

            // Find the button that was clicked and activate it
            const buttons = document.querySelectorAll('.tabs .tab-btn');
            for (const btn of buttons) {
                if (btn.getAttribute('onclick').includes(`'${tabId}'`)) {
                    btn.classList.add('active');
                    break;
                }
            }
        }

        async function populateExportVersions() {
            const select = document.getElementById('exportVersionSelect');
            const currentSelected = select.value;

            // For each version, check if all server/both mods are compatible
            const compatibleVersions = [];

            for (const v of versions) {
                try {
                    const res = await fetch(`${API_BASE}/results/summary?mc_version=${v.version}&loader=${v.loader}`);
                    const summary = await res.json();

                    // Only check server-side compatibility (server + both mods)
                    // Client-side only mods don't matter for server exports
                    if (summary.server_total > 0 && summary.server_compatible === summary.server_total) {
                        compatibleVersions.push({ version: v.version, loader: v.loader });
                    }
                } catch (e) {
                    console.error('Failed to get summary for', v.version, e);
                }
            }

            if (compatibleVersions.length === 0) {
                select.innerHTML = `<option value="" data-i18n="import_export_panel.no_compatible_versions">${i18n.t('import_export_panel.no_compatible_versions')}</option>`;
            } else {

                select.innerHTML = compatibleVersions.map(v =>
                    `<option value="${v.version}|${v.loader}" ${v.version === currentSelected ? 'selected' : ''}>${v.version} (${v.loader})</option>`
                ).join('');
            }
        }

        async function exportMods() {
            const selectedVal = document.getElementById('exportVersionSelect').value;
            if (!selectedVal) {
                showToast(i18n.t('toasts.select_export_version'), 'error');
                return;
            }


            const [version, loader] = selectedVal.split('|');

            try {
                const res = await fetch(`${API_BASE}/mods/export?mc_version=${encodeURIComponent(version)}&loader=${encodeURIComponent(loader)}`);
                if (!res.ok) {
                    const error = await res.json();
                    throw new Error(error.detail || 'Export failed');
                }
                const data = await res.json();
                document.getElementById('yamlContent').value = data.yaml;

                // Try to copy to clipboard (requires secure context)
                try {
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        await navigator.clipboard.writeText(data.yaml);
                        showToast(i18n.t('toasts.exported_clipboard'), 'success');
                    } else {
                        showToast(i18n.t('toasts.exported_no_clipboard'), 'info');
                    }
                } catch (clipboardError) {
                    console.warn('Clipboard copy failed:', clipboardError);
                    showToast(i18n.t('toasts.exported_manual'), 'info');
                }

            } catch (error) {
                console.error('Export failed:', error);
                showToast(error.message || 'Export failed', 'error');
            }
        }

        async function importMods() {
            const yaml = document.getElementById('yamlContent').value.trim();
            if (!yaml) {
                showToast(i18n.t('toasts.paste_yaml'), 'error');
                return;
            }


            try {
                const res = await fetch(`${API_BASE}/mods/import`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ yaml })
                });

                if (!res.ok) {
                    const error = await res.json();
                    throw new Error(error.detail || 'Import failed');
                }

                const result = await res.json();
                showToast(i18n.t('toasts.import_success', { count: result.added }), 'success');
                loadInitialData();

            } catch (error) {
                showToast(error.message, 'error');
            }
        }


        async function loadBackgroundStatus() {
            try {
                const res = await fetch(`${API_BASE}/status`);
                const data = await res.json();

                const lastCheckEl = document.getElementById('lastCheckTime');
                const nextCheckEl = document.getElementById('nextCheckTime');

                if (data.last_check) {
                    lastCheckEl.innerHTML = i18n.t('last_check', { time: formatDate(data.last_check) });
                } else {
                    lastCheckEl.innerHTML = i18n.t('last_check', { time: i18n.t('never') });
                }


                if (data.next_check) {
                    const nextDate = new Date(data.next_check);
                    nextCheckEl.innerHTML = i18n.t('next_check', { time: nextDate.toLocaleTimeString() });
                } else {
                    nextCheckEl.innerHTML = i18n.t('next_check', { time: '--:--:--' });
                }

            } catch (error) {
                console.error('Failed to load background status', error);
            }
        }

        function formatDate(dateStr) {
            if (!dateStr) return i18n.t('never');
            const date = new Date(dateStr);
            const now = new Date();
            const diff = Math.floor((now - date) / 1000);

            if (diff < 60) return i18n.currentLang === 'pl' ? 'Przed chwilƒÖ' : 'Just now';
            if (diff < 3600) return `${Math.floor(diff / 60)}m ${i18n.currentLang === 'pl' ? 'temu' : 'ago'}`;
            if (diff < 86400) return `${Math.floor(diff / 3600)}h ${i18n.currentLang === 'pl' ? 'temu' : 'ago'}`;
            return date.toLocaleDateString();
        }


        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideOut 300ms ease';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        // Refresh data every 10 seconds
        setInterval(loadInitialData, 10000);

        // Initial load
        loadInitialData();
    </script>
</body>

</html>