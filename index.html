<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minecraft Mod Compatibility Checker</title>
    <style>
        :root {
            --primary: #32b8c6;
            --primary-dark: #1a7481;
            --bg-dark: #1f2121;
            --bg-light: #2a2d2d;
            --text-primary: #f5f5f5;
            --text-secondary: #a7a9a9;
            --success: #32c659;
            --warning: #e68179;
            --error: #c01547;
            --border: rgba(119, 124, 124, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 30px 0;
            margin-bottom: 30px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        h1 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .subtitle {
            font-size: 14px;
            opacity: 0.9;
        }

        .status-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .status-card {
            background: var(--bg-light);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .status-icon {
            font-size: 24px;
            min-width: 30px;
        }

        .status-content h3 {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-content p {
            font-size: 16px;
            font-weight: 500;
        }

        .status-card.loading .status-icon {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .panel {
            background: var(--bg-light);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
        }

        .panel-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 6px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 14px;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(50, 184, 198, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 200ms ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--bg-dark);
            width: 100%;
            justify-content: center;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(50, 184, 198, 0.2);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: transparent;
            color: var(--primary);
            border: 1px solid var(--primary);
            padding: 8px 12px;
            font-size: 12px;
        }

        .btn-secondary:hover {
            background: rgba(50, 184, 198, 0.1);
        }

        .btn-sm {
            padding: 6px 10px;
            font-size: 12px;
        }

        .mods-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .mod-item,
        .version-item {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: start;
            transition: all 200ms ease;
        }

        .mod-item:hover,
        .version-item:hover {
            border-color: var(--primary);
            background: rgba(50, 184, 198, 0.05);
        }

        .mod-info,
        .version-info-text {
            flex: 1;
        }

        .mod-name {
            font-weight: 500;
            margin-bottom: 4px;
        }

        .mod-side {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .mod-slug {
            font-size: 12px;
            color: var(--primary);
            font-family: 'Courier New', monospace;
        }

        .mod-actions,
        .version-actions {
            display: flex;
            gap: 8px;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-client {
            background: rgba(100, 150, 200, 0.2);
            color: #64a8c8;
        }

        .badge-server {
            background: rgba(80, 150, 120, 0.2);
            color: #50b878;
        }

        .badge-fabric {
            background: rgba(100, 120, 180, 0.2);
            color: #6478b4;
        }

        .badge-forge {
            background: rgba(180, 120, 80, 0.2);
            color: #b47850;
        }

        .badge-quilt {
            background: rgba(150, 100, 180, 0.2);
            color: #9664b4;
        }

        .badge-neoforge {
            background: rgba(180, 150, 80, 0.2);
            color: #b49650;
        }

        .badge-success {
            background: rgba(50, 198, 89, 0.2);
            color: var(--success);
        }

        .badge-warning {
            background: rgba(230, 129, 97, 0.2);
            color: #e68179;
        }

        .badge-error {
            background: rgba(192, 21, 47, 0.2);
            color: var(--error);
        }

        .badge-current {
            background: rgba(50, 198, 89, 0.2);
            color: var(--success);
        }

        .compatibility-result {
            background: var(--bg-dark);
            border-left: 3px solid var(--border);
            border-radius: 4px;
            padding: 12px;
            margin-bottom: 10px;
            font-size: 13px;
        }

        .compatibility-result.compatible {
            border-left-color: var(--success);
            background: rgba(50, 198, 89, 0.05);
        }

        .compatibility-result.incompatible {
            border-left-color: var(--error);
            background: rgba(192, 21, 47, 0.05);
        }

        .compatibility-result.error {
            border-left-color: var(--warning);
            background: rgba(230, 129, 97, 0.05);
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .result-name {
            font-weight: 500;
        }

        .result-status {
            font-size: 12px;
            font-weight: 600;
        }

        .result-details {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 6px;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .separator {
            height: 1px;
            background: var(--border);
            margin: 20px 0;
        }

        .last-check {
            font-size: 12px;
            color: var(--text-secondary);
            text-align: center;
            margin-top: 15px;
        }

        .version-info-box {
            background: rgba(50, 184, 198, 0.1);
            border: 1px solid var(--primary);
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 15px;
            font-size: 13px;
        }

        .version-info-label {
            color: var(--text-secondary);
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .version-info-value {
            font-weight: 500;
            color: var(--primary);
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 22px;
            }

            .status-bar {
                grid-template-columns: 1fr 1fr;
            }
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border);
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 10px 15px;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid transparent;
            transition: all 200ms ease;
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--bg-light);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            animation: slideIn 300ms ease;
            z-index: 1000;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast.success {
            border-left: 3px solid var(--success);
        }

        .toast.error {
            border-left: 3px solid var(--error);
        }

        .toast.info {
            border-left: 3px solid var(--primary);
        }
    </style>
</head>

<body>
    <header>
        <div class="container">
            <h1>üéÆ Minecraft Mod Compatibility Checker</h1>
            <p class="subtitle">Check your mod compatibility with your Minecraft server version</p>
        </div>
    </header>

    <div class="container">
        <div class="status-bar">
            <div class="status-card">
                <div class="status-icon">üì¶</div>
                <div class="status-content">
                    <h3>Current MC Version</h3>
                    <p id="currentVersion">Not Set</p>
                    <p id="currentVersionSummary" style="font-size: 11px; opacity: 0.8; margin-top: 2px;"></p>
                </div>
            </div>
            <div class="status-card">
                <div class="status-icon">üöÄ</div>
                <div class="status-content">
                    <h3>Latest Official</h3>
                    <p id="latestOfficialVersion">Checking...</p>
                    <p id="latestOfficialSummary" style="font-size: 11px; opacity: 0.8; margin-top: 2px;"></p>
                </div>
            </div>
            <div class="status-card">
                <div class="status-icon">‚è±Ô∏è</div>
                <div class="status-content">
                    <h3>Last Background Check</h3>
                    <p id="lastCheckTime">Never</p>
                </div>
            </div>
            <div class="status-card">
                <div class="status-icon">üìö</div>
                <div class="status-content">
                    <h3>Tracked Mods</h3>
                    <p id="modsCount">0</p>
                </div>
            </div>
            <div class="status-card">
                <div class="status-icon">‚úì</div>
                <div class="status-content">
                    <h3>Compatible Mods</h3>
                    <p id="compatCount">0 / 0</p>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="panel">
                <div class="tabs">
                    <button class="tab-btn active" onclick="switchPanel('add-mod')">Add Mod</button>
                    <button class="tab-btn" onclick="switchPanel('versions')">Manage Versions</button>
                    <button class="tab-btn" onclick="switchPanel('import-export')">Export/Import</button>
                </div>

                <div id="add-mod" class="tab-content active">
                    <div class="panel-title">üìù Add Mod to Track</div>

                    <div class="form-group">
                        <label>Mod Loader</label>
                        <select id="modLoader">
                            <option value="fabric">Fabric</option>
                            <option value="forge">Forge</option>
                            <option value="quilt">Quilt</option>
                            <option value="neoforge">NeoForge</option>
                            <option value="liteloader">LiteLoader</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Mod Slug (from Modrinth)</label>
                        <input type="text" id="modSlug" placeholder="e.g., sodium, lithium, iris">
                    </div>

                    <div class="form-group">
                        <label>Mod Type</label>
                        <select id="modSide">
                            <option value="both">Both (Client + Server)</option>
                            <option value="client">Client Only</option>
                            <option value="server">Server Only</option>
                        </select>
                    </div>

                    <button class="btn btn-primary" onclick="addMod()">‚ûï Add Mod</button>

                    <div class="separator"></div>
                    <div class="panel-title">üìã Tracked Mods</div>

                    <div class="mods-list" id="modsList">
                        <div class="empty-state">
                            <div class="empty-state-icon">üì≠</div>
                            <p>No mods tracked yet</p>
                        </div>
                    </div>
                </div>

                <div id="versions" class="tab-content">
                    <div class="panel-title">üîß Manage Minecraft Versions</div>

                    <div class="form-group">
                        <label>Minecraft Version (e.g., 1.21.1)</label>
                        <input type="text" id="newVersion" placeholder="1.21.1">
                    </div>

                    <div class="form-group">
                        <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 15px;">
                            <input type="checkbox" id="setAsCurrent" style="width: auto; margin-right: 8px;">
                            <span>Set as current server version</span>
                        </label>
                    </div>

                    <button class="btn btn-primary" onclick="addVersion()">‚ûï Add Version</button>

                    <div class="separator"></div>
                    <div class="panel-title">üìå Version List</div>

                    <div class="mods-list" id="versionsList">
                        <div class="empty-state">
                            <div class="empty-state-icon">üì≠</div>
                            <p>No versions added yet</p>
                        </div>
                    </div>
                </div>

                <div id="import-export" class="tab-content">
                    <div class="panel-title">üì§ Export / üì• Import</div>
                    <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 12px;">
                        Manage your mod list using Docker Compose format (<code>itzg/minecraft-server</code> style).
                    </p>

                    <div class="form-group">
                        <label>Select Minecraft Version for Export</label>
                        <select id="exportVersionSelect">
                            <option value="">No compatible versions found</option>
                        </select>
                        <p style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">Only versions with
                            100% compatibility are shown.</p>
                    </div>

                    <div class="form-group">
                        <label>Compose YAML / MODRINTH_PROJECTS</label>
                        <textarea id="yamlContent" placeholder="Paste your docker-compose.yml here..."></textarea>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <button class="btn btn-secondary" onclick="exportMods()">üì§ Export Current</button>
                        <button class="btn btn-primary" onclick="importMods()">üì• Import from Above</button>
                    </div>
                </div>
            </div>

            <div class="panel">
                <div class="tabs">
                    <button class="tab-btn active" onclick="switchTab('results')">Compatibility Results</button>
                    <button class="tab-btn" onclick="switchTab('logs')">Background Job Logs</button>
                </div>

                <div id="results" class="tab-content active">
                    <div class="version-info-box"
                        style="display: flex; justify-content: space-between; align-items: flex-end; gap: 15px;">
                        <div style="flex: 1;">
                            <div class="version-info-label">Filter by Minecraft Version</div>
                            <select id="resultVersionFilter" onchange="fetchResults()"
                                style="background: var(--bg-dark); border: 1px solid var(--border); border-radius: 4px; padding: 6px 10px; color: var(--text-primary); font-size: 13px; width: 100%;">
                                <option value="">All Versions</option>
                            </select>
                        </div>
                    </div>

                    <div id="resultsContainer">
                        <div class="empty-state">
                            <div class="empty-state-icon">üîç</div>
                            <p>Add mods to see compatibility results</p>
                        </div>
                    </div>
                </div>

                <div id="logs" class="tab-content">
                    <div style="background: var(--bg-dark); border-radius: 6px; padding: 12px; font-family: 'Courier New', monospace; font-size: 12px; max-height: 400px; overflow-y: auto;"
                        id="logsContainer">
                        <div style="color: var(--text-secondary);">Waiting for background job logs...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let mods = [];
        let versions = [];
        let results = [];
        let logs = [];
        let currentVersion = null;
        let latestOfficialVersion = null;

        async function loadInitialData() {
            try {
                // Load versions & Determine Latest
                const versionsRes = await fetch(`${API_BASE}/versions`);
                versions = await versionsRes.json();

                // Sort versions desc by release time if available, or just assumption
                // The API returns ordered by version string, we should probably sort by release_time or just rely on backend
                // Let's sort client side to be sure for display
                versions.sort((a, b) => {
                    const tA = new Date(a.release_time || 0);
                    const tB = new Date(b.release_time || 0);
                    return tB - tA;
                });

                const latestOfficial = versions.find(v => v.type === 'release');
                if (latestOfficial) {
                    latestOfficialVersion = latestOfficial.version;
                    document.getElementById('latestOfficialVersion').innerHTML = latestOfficialVersion;
                }

                // Populate filter dropdown
                const filterSelect = document.getElementById('resultVersionFilter');
                const currentFilter = filterSelect.value;
                filterSelect.innerHTML = '<option value="">All Versions</option>' +
                    versions.map(v => `<option value="${v.version}">${v.version}${v.is_current ? ' (Current)' : ''}</option>`).join('');
                filterSelect.value = currentFilter;

                // Load current version
                const currentRes = await fetch(`${API_BASE}/versions/current`);
                const currentData = await currentRes.json();
                currentVersion = currentData.version;

                renderVersions();
                if (!currentVersion) {
                    document.getElementById('currentVersion').innerHTML = 'Not Set';
                } else {
                    document.getElementById('currentVersion').innerHTML = currentVersion;
                }

                // Load mods
                const modsRes = await fetch(`${API_BASE}/mods`);
                mods = await modsRes.json();
                renderMods();

                // Load results
                await fetchResults();
                await populateExportVersions();

                // Load logs
                const logsRes = await fetch(`${API_BASE}/logs`);
                logs = await logsRes.json();
                renderLogs();

                updateStats();
            } catch (error) {
                showToast('Failed to load initial data', 'error');
                console.error(error);
            }
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            return new Date(dateStr).toLocaleDateString();
        }

        async function addVersion() {
            const versionStr = document.getElementById('newVersion').value.trim();
            const isCurrent = document.getElementById('setAsCurrent').checked;

            if (!versionStr) {
                showToast('Please enter a version', 'error');
                return;
            }

            try {
                // If the user manually adds a version, we post it. 
                // The backend syncs usually, but manual add is fine.
                const res = await fetch(`${API_BASE}/versions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ version: versionStr, is_current: isCurrent })
                });

                if (!res.ok) {
                    const error = await res.json();
                    throw new Error(error.detail || 'Failed to add version');
                }

                showToast('Version added. Refreshing...', 'success');
                loadInitialData(); // Re-fetch all to get correct sort/times
                document.getElementById('newVersion').value = '';
                document.getElementById('setAsCurrent').checked = false;

            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        // ... (setCurrentVersion, deleteVersion same as before) ...

        function renderVersions() {
            const container = document.getElementById('versionsList');
            if (versions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì≠</div>
                        <p>No versions added yet</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = versions.map(v => `
                <div class="version-item">
                    <div class="version-info-text">
                        <div class="mod-name">${v.version}</div>
                        <div class="mod-side">
                           ${v.type || 'custom'} ‚Ä¢ ${formatDate(v.release_time) || 'Unknown date'}
                        </div>
                        ${v.is_current ? '<span class="badge badge-current">üéØ Current</span>' : ''}
                    </div>
    
                    <div class="version-actions">
                        ${!v.is_current ? `<button class="btn btn-secondary btn-sm" onclick="setCurrentVersion(${v.id})">Set Current</button>` : ''}
                        ${!v.is_current ? `<button class="btn btn-secondary btn-sm" onclick="deleteVersion(${v.id})">Delete</button>` : ''}
                    </div>
                </div>
            `).join('');
        }

        async function fetchResults() {
            try {
                const mcFilter = document.getElementById('resultVersionFilter').value;
                const url = new URL(`${window.location.origin}${API_BASE}/results`);
                if (mcFilter) url.searchParams.append('mc_version', mcFilter);

                const res = await fetch(url);
                results = await res.json();
                renderResults();
            } catch (error) {
                console.error('Failed to fetch results', error);
            }
        }

        function renderResults() {
            const container = document.getElementById('resultsContainer');
            if (results.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üîç</div>
                        <p>No compatibility results found for selected filters.</p>
                    </div>`;
                return;
            }

            // Since backend returns sorted results (Mod name ASC, MC Newest DESC)
            // We can just render them. However, we might want to group by mod to keep the previous UI style.

            const resultsByMod = {};
            const modOrder = []; // To keep deterministic order from backend

            results.forEach(r => {
                if (!resultsByMod[r.mod_slug]) {
                    resultsByMod[r.mod_slug] = [];
                    modOrder.push(r.mod_slug);
                }
                resultsByMod[r.mod_slug].push(r);
            });

            let html = '';

            for (const modSlug of modOrder) {
                const modResults = resultsByMod[modSlug];
                // Within each mod, backend already sorted by MC release time

                // Get most recent check for each MC version to avoid duplicates in display
                const uniqueChecks = {};
                modResults.forEach(r => {
                    if (!uniqueChecks[r.mc_version]) uniqueChecks[r.mc_version] = r;
                });

                // Keep the order of versions as they appeared from backend
                const versionsShown = [];
                modResults.forEach(r => {
                    if (!versionsShown.includes(r.mc_version)) versionsShown.push(r.mc_version);
                });

                html += `
                    <div class="compatibility-result">
                        <div class="result-header">
                            <span class="result-name">${modSlug}</span>
                        </div>
                        <div class="separator" style="margin: 8px 0;"></div>
                 `;

                versionsShown.forEach(ver => {
                    const r = uniqueChecks[ver];
                    let badgeClass = 'badge-warning';
                    if (r.status === 'compatible') badgeClass = 'badge-success';
                    if (r.status === 'incompatible') badgeClass = 'badge-error';

                    let statusText = r.status === 'compatible' ? '‚úì Compatible' :
                        r.status === 'incompatible' ? '‚úó Incompatible' : '‚ö†Ô∏è Error';

                    html += `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                            <div style="font-size: 13px;">
                                <span style="font-weight: 600;">MC ${ver}</span>
                                <span style="color: var(--text-secondary); font-size: 11px; margin-left: 8px;">(${r.loader})</span>
                            </div>
                            <span class="badge ${badgeClass}">${statusText}</span>
                        </div>
                        ${r.mod_version_id ? `<div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Mod Version: ${r.mod_version_id}</div>` : ''}
                        ${r.error ? `<div class="result-details" style="color:var(--error)">${r.error}</div>` : ''}
                     `;
                });
                html += `</div>`;
            }

            container.innerHTML = html;
        }

        async function addMod() {
            const slug = document.getElementById('modSlug').value.trim();
            const loader = document.getElementById('modLoader').value;
            const side = document.getElementById('modSide').value;

            if (!slug) {
                showToast('Please enter a mod slug', 'error');
                return;
            }

            /*
            if (!currentVersion) {
                showToast('Please set a current Minecraft version first', 'error');
                return;
            }
            */

            try {
                const res = await fetch(`${API_BASE}/mods`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ slug, mc_version: currentVersion, loader, side })
                });

                if (!res.ok) {
                    const error = await res.json();
                    throw new Error(error.detail || 'Failed to add mod');
                }

                const newMod = await res.json();
                mods.push(newMod);
                renderMods();
                updateStats();
                document.getElementById('modSlug').value = '';
                showToast('Mod added successfully', 'success');
            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        async function removeMod(modId) {
            try {
                const res = await fetch(`${API_BASE}/mods/${modId}`, { method: 'DELETE' });
                if (res.ok) {
                    mods = mods.filter(m => m.id !== modId);
                    renderMods();
                    updateStats();
                    showToast('Mod removed', 'success');
                }
            } catch (error) {
                showToast('Failed to remove mod', 'error');
            }
        }

        function getLoaderBadgeClass(loader) {
            const badgeMap = {
                'fabric': 'badge-fabric',
                'forge': 'badge-forge',
                'quilt': 'badge-quilt',
                'neoforge': 'badge-neoforge',
                'liteloader': 'badge-client'
            };
            return badgeMap[loader] || 'badge-client';
        }

        function renderMods() {
            const container = document.getElementById('modsList');
            if (mods.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì≠</div>
                        <p>No mods tracked yet</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = mods.map(mod => `
                <div class="mod-item">
                    <div class="mod-info">
                        <div class="mod-name">${mod.slug}</div>
                        <div class="mod-side">MC ${mod.mc_version} ‚Ä¢ ${mod.loader}</div>
                        <div class="mod-slug">
                            <span class="badge ${mod.side === 'client' ? 'badge-client' : mod.side === 'server' ? 'badge-server' : 'badge-client'}">
                                ${mod.side === 'both' ? 'üñ•Ô∏è Client+Server' : mod.side === 'client' ? 'üë§ Client' : 'üñß Server'}
                            </span>
                            <span class="badge ${getLoaderBadgeClass(mod.loader)}">
                                ${mod.loader.toUpperCase()}
                            </span>
                        </div>
                    </div>
                    <div class="mod-actions">
                        <button class="btn btn-secondary" onclick="removeMod(${mod.id})">Remove</button>
                    </div>
                </div>
            `).join('');
        }

        function renderResults() {
            const container = document.getElementById('resultsContainer');
            if (results.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üîç</div>
                        <p>No compatibility checks yet. Background job will run every 5 minutes.</p>
                    </div>
                `;
                return;
            }

            const grouped = {};
            results.forEach(r => {
                const key = `${r.mod_slug}-${r.mc_version}-${r.loader}`;
                if (!grouped[key]) grouped[key] = r;
                else if (new Date(r.checked_at) > new Date(grouped[key].checked_at)) {
                    grouped[key] = r;
                }
            });

            container.innerHTML = Object.values(grouped).map(result => {
                const status = result.status === 'compatible' ? 'compatible' :
                    result.status === 'incompatible' ? 'incompatible' : 'error';
                const statusText = result.status === 'compatible' ? '‚úì Compatible' :
                    result.status === 'incompatible' ? '‚úó Incompatible' : '‚ö†Ô∏è Error';

                return `
                    <div class="compatibility-result ${status}">
                        <div class="result-header">
                            <span class="result-name">${result.mod_slug}</span>
                            <span class="badge ${result.status === 'compatible' ? 'badge-success' : result.status === 'incompatible' ? 'badge-error' : 'badge-warning'}">
                                ${statusText}
                            </span>
                        </div>
                        <div class="result-details">
                            <strong>Version:</strong> ${result.mc_version} ‚Ä¢ <strong>Loader:</strong> ${result.loader.toUpperCase()}<br>
                            ${result.mod_version_id ? `<strong>Mod Version ID:</strong> <span style="font-family: monospace; background: rgba(0,0,0,0.2); padding: 2px 4px; border-radius: 4px;">${result.mod_version_id}</span><br>` : ''}
                            <strong>Checked:</strong> ${formatDate(result.checked_at)}
                            ${result.error ? `<br><strong style="color: var(--error);">Error:</strong> ${result.error}` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderLogs() {
            const container = document.getElementById('logsContainer');
            if (logs.length === 0) {
                container.innerHTML = '<div style="color: var(--text-secondary);">No logs yet. Background job will start soon...</div>';
                return;
            }

            container.innerHTML = logs.map(log => {
                const timestamp = new Date(log.created_at).toLocaleTimeString();
                const levelColor = log.level === 'ERROR' ? 'var(--error)' :
                    log.level === 'WARNING' ? 'var(--warning)' : 'var(--primary)';
                return `<div style="color: ${levelColor}; margin-bottom: 4px;"><strong>[${timestamp}]</strong> ${log.message}</div>`;
            }).join('');

            container.scrollTop = container.scrollHeight;
        }

        async function updateStats() {
            document.getElementById('modsCount').innerHTML = mods.length;

            const compatible = results.filter(r => r.status === 'compatible').length;
            const total = new Set(results.map(r => `${r.mod_slug}-${r.mc_version}-${r.loader}`)).size;
            document.getElementById('compatCount').innerHTML = `${compatible} / ${total}`;

            // Fetch summaries for badges
            const updateBadge = async (version, elementId) => {
                if (!version) return;
                try {
                    const res = await fetch(`${API_BASE}/results/summary?mc_version=${version}`);
                    const data = await res.json();

                    let emoji = '';
                    let color = 'inherit';

                    if (data.total > 0) {
                        if (data.compatible === data.total) {
                            emoji = ' ‚úÖ';
                            color = 'var(--success)';
                        } else {
                            emoji = ' ‚ùå';
                            color = 'var(--error)';
                        }
                    } else if (mods.length > 0) {
                        emoji = ' ‚è≥'; // Pending checks for this version
                    }

                    const el = document.getElementById(elementId);
                    el.innerHTML = `${data.compatible} / ${data.total} compatible${emoji}`;
                    el.style.color = color;
                } catch (e) {
                    console.error('Failed to update badge stats', e);
                }
            };

            await updateBadge(currentVersion, 'currentVersionSummary');
            await updateBadge(latestOfficialVersion, 'latestOfficialSummary');
        }

        function switchPanel(panel) {
            document.querySelectorAll('[id^="add-mod"], [id^="versions"], [id^="import-export"]').forEach(el => {
                if (el.id === panel) el.classList.add('active');
                else el.classList.remove('active');
            });
            document.querySelectorAll('.tabs .tab-btn').forEach((btn, idx) => {
                const panels = ['add-mod', 'versions', 'import-export'];
                if (panels[idx] === panel) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        async function populateExportVersions() {
            const select = document.getElementById('exportVersionSelect');
            const currentSelected = select.value;

            // For each version, check if all mods are compatible
            const compatibleVersions = [];

            for (const v of versions) {
                try {
                    const res = await fetch(`${API_BASE}/results/summary?mc_version=${v.version}`);
                    const summary = await res.json();

                    if (summary.total > 0 && summary.compatible === summary.total) {
                        compatibleVersions.push(v.version);
                    }
                } catch (e) {
                    console.error('Failed to get summary for', v.version, e);
                }
            }

            if (compatibleVersions.length === 0) {
                select.innerHTML = '<option value="">No fully compatible versions</option>';
            } else {
                select.innerHTML = compatibleVersions.map(v =>
                    `<option value="${v}" ${v === currentSelected ? 'selected' : ''}>${v}</option>`
                ).join('');
            }
        }

        async function exportMods() {
            const selectedVersion = document.getElementById('exportVersionSelect').value;
            if (!selectedVersion) {
                showToast('Please select a compatible version to export', 'error');
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/mods/export?mc_version=${encodeURIComponent(selectedVersion)}`);
                if (!res.ok) {
                    const error = await res.json();
                    throw new Error(error.detail || 'Export failed');
                }
                const data = await res.json();
                document.getElementById('yamlContent').value = data.yaml;

                // Try to copy to clipboard (requires secure context)
                try {
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        await navigator.clipboard.writeText(data.yaml);
                        showToast('Exported and copied to clipboard!', 'success');
                    } else {
                        showToast('Exported! (Clipboard not supported in this browser/context)', 'info');
                    }
                } catch (clipboardError) {
                    console.warn('Clipboard copy failed:', clipboardError);
                    showToast('Exported! (Manual copy required)', 'info');
                }
            } catch (error) {
                console.error('Export failed:', error);
                showToast(error.message || 'Export failed', 'error');
            }
        }

        async function importMods() {
            const yaml = document.getElementById('yamlContent').value.trim();
            if (!yaml) {
                showToast('Please paste YAML content first', 'error');
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/mods/import`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ yaml })
                });

                if (!res.ok) {
                    const error = await res.json();
                    throw new Error(error.detail || 'Import failed');
                }

                const result = await res.json();
                showToast(`Successfully imported ${result.added} new mods!`, 'success');
                loadInitialData();
            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tabs .tab-btn').forEach(el => el.classList.remove('active'));

            document.getElementById(tab).classList.add('active');
            event.target.classList.add('active');
        }

        function formatDate(dateStr) {
            if (!dateStr) return 'Never';
            const date = new Date(dateStr);
            const now = new Date();
            const diff = Math.floor((now - date) / 1000);

            if (diff < 60) return 'Just now';
            if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
            if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
            return date.toLocaleDateString();
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideOut 300ms ease';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        // Refresh data every 10 seconds
        setInterval(loadInitialData, 10000);

        // Initial load
        loadInitialData();
    </script>
</body>

</html>